name: Tag/Release on Push Action and create CHANGELOG

on:
  push:
    branches:
      - master

jobs:
  release-on-push:
    name: "Release on push to Master"
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: rymndhng/release-on-push-action@master
        name: Tag and Realease
        with:
          bump_version_scheme: minor
  generate-changelog:
    needs: release-on-push
    name: "Generate Changelog after release"
    runs-on: ubuntu-latest
    steps:
#      - name: Get Previous Tag
#        run: |
#          PREV_TAG=$(git describe --abbrev=0 --tags "${{ github.ref }}^")
#          echo "::set-env name=baseRef::$PREV_TAG"
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - uses: heinrichreimer/github-changelog-generator-action@v2.1.1
        id: generate_changelog
        name: Generate Changelog
        with:
          pullRequests: true
          includeLabels: true
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Commit files
        run: |
          git config --local user.name  ${{ github.actor }}
          echo ${{steps.generate_changelog.outputs.changelog}} >> CHANGELOG.md
          git add CHANGELOG.md && git commit -m 'Updated CHANGELOG.md' && echo ::set-env name=push::1 || echo "No changes to CHANGELOG.md"
      - name: Push changes  # push the output folder to your repo
        if: env.push == 1
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          force: true
